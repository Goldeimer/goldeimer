version: '3.3'

services:
    db:
        image: mysql:5.7
        restart: always
        volumes:
            - ./data/db:/var/lib/mysql
        environment:
            MYSQL_ROOT_PASSWORD: wordpressrootpw
            MYSQL_DATABASE: wordpress
            MYSQL_USER: wordpress
            MYSQL_PASSWORD: wordpress

    # PHP FPM services requests over port 9000
    php:
        image: wordpress:5-fpm
        depends_on:
            - db
        restart: always
        volumes:
            - ./php-uploads.ini:/usr/local/etc/php/conf.d/uploads.ini
            - ./wordpress:/var/www/html
        environment:
            WORDPRESS_DB_HOST: db:3306
            WORDPRESS_DB_USER: wordpress
            WORDPRESS_DB_PASSWORD: wordpress

    web:
        image: nginx
        depends_on:
            - php
        restart: always
        volumes:
            - ./nginx.conf:/etc/nginx/conf.d/default.conf
            - ./wordpress:/var/www/html
            - ./logs:/var/log/nginx

    https-portal:
        image: steveltn/https-portal:1
        depends_on:
            - web
        ports:
            - 80:80
            - 443:443
        restart: always
        volumes:
            # persistent certs
            - ./ssl_certs:/var/lib/https-portal
        environment:
            DOMAINS: 'localhost -> http://web:80'
            STAGE: local
            FORCE_RENEW: 'true'
            CLIENT_MAX_BODY_SIZE: 64M
