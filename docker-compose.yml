version: '3.7'

secrets:
    secret_wordpress_db_name:
        file: ./secrets/secret_wordpress_db_name.txt
    secret_wordpress_db_password:
        file: ./secrets/secret_wordpress_db_password.txt
    secret_wordpress_db_user:
        file: ./secrets/secret_wordpress_db_user.txt
    secret_wordpress_table_prefix:
        file: ./secrets/secret_wordpress_table_prefix.txt

services:
    db:
        image: mysql:5.7
        restart: always
        volumes:
            - ./sql:/docker-entrypoint-initdb.d
            - ./data/db:/var/lib/mysql
        secrets:
            - secret_wordpress_db_name
            - secret_wordpress_db_password
            - secret_wordpress_db_user
        environment:
            MYSQL_ROOT_PASSWORD: mysqlrootpw
            MYSQL_DATABASE_FILE: /run/secrets/secret_wordpress_db_name
            MYSQL_PASSWORD_FILE: /run/secrets/secret_wordpress_db_password
            MYSQL_USER_FILE: /run/secrets/secret_wordpress_db_user

    # PHP FPM services requests over port 9000
    php:
        image: wordpress:5-fpm
        depends_on:
            - db
        restart: always
        volumes:
            - ./etc/php-uploads.ini:/usr/local/etc/php/conf.d/uploads.ini
            - ./wordpress:/var/www/html
        secrets:
            - secret_wordpress_db_name
            - secret_wordpress_db_password
            - secret_wordpress_db_user
            - secret_wordpress_table_prefix
        environment:
            WORDPRESS_DB_HOST: db:3306
            WORDPRESS_DB_NAME_FILE: /run/secrets/secret_wordpress_db_name
            WORDPRESS_DB_PASSWORD_FILE: /run/secrets/secret_wordpress_db_password
            WORDPRESS_DB_USER_FILE: /run/secrets/secret_wordpress_db_user
            WORDPRESS_TABLE_PREFIX_FILE: /run/secrets/secret_wordpress_table_prefix

    web:
        image: nginx
        depends_on:
            - php
        restart: always
        volumes:
            - ./etc/nginx.conf:/etc/nginx/conf.d/default.conf
            - ./wordpress:/var/www/html
            - ./logs:/var/log/nginx

    https-portal:
        image: steveltn/https-portal:1
        depends_on:
            - web
        ports:
            - 80:80
            - 443:443
        restart: always
        volumes:
            # persistent certs
            - ./ssl_certs:/var/lib/https-portal
        environment:
            DOMAINS: 'www.goldeimer.lc -> http://web:80'
            STAGE: local
            FORCE_RENEW: 'true'
            CLIENT_MAX_BODY_SIZE: 64M
